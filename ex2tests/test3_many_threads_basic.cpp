/*
 * test3.cc - Many threads: Create close to the maximal number of threads. Check that the switching is done in the right order.
 * 
 * Output should be:
 *
 test3:
 --------------
 ***0***
 ***1***
 ***2***
 ***3***
 ***4***
 ***5***
 ***6***
 ***7***
 ***8***
 ***9***
 ***10***
 ***11***
 ***12***
 ***13***
 ***14***
 ***15***
 ***16***
 ***17***
 ***18***
 ***19***
 ***20***
 ***21***
 ***22***
 ***23***
 ***24***
 ***25***
 ***26***
 ***27***
 ***28***
 ***29***
 ***30***
 ***31***
 ***32***
 ***33***
 ***34***
 ***35***
 ***36***
 ***37***
 ***38***
 ***39***
 ***40***
 ***41***
 ***42***
 ***43***
 ***44***
 ***45***
 ***46***
 ***47***
 ***48***
 ***49***
 ***50***
 ***51***
 ***52***
 ***53***
 ***54***
 ***55***
 ***56***
 ***57***
 ***58***
 ***59***
 ***60***
 ***61***
 ***62***
 ***63***
 ***64***
 ***65***
 ***66***
 ***67***
 ***68***
 ***69***
 ***70***
 ***71***
 ***72***
 ***73***
 ***74***
 ***75***
 ***76***
 ***77***
 ***78***
 ***79***
 ***80***
 ***81***
 ***82***
 ***83***
 ***84***
 ***85***
 ***86***
 ***87***
 ***88***
 ***89***
 ***90***
 ***91***
 ***92***
 ***93***
 ***94***
 ***95***
 ***96***
 ***97***
 ***0***
 ***1***
 ***2***
 ***3***
 ***4***
 ***5***
 ***6***
 ***7***
 ***8***
 ***9***
 ***10***
 ***11***
 ***12***
 ***13***
 ***14***
 ***15***
 ***16***
 ***17***
 ***18***
 ***19***
 ***20***
 ***21***
 ***22***
 ***23***
 ***24***
 ***25***
 ***26***
 ***27***
 ***28***
 ***29***
 ***30***
 ***31***
 ***32***
 ***33***
 ***34***
 ***35***
 ***36***
 ***37***
 ***38***
 ***39***
 ***40***
 ***41***
 ***42***
 ***43***
 ***44***
 ***45***
 ***46***
 ***47***
 ***48***
 ***49***
 ***50***
 ***51***
 ***52***
 ***53***
 ***54***
 ***55***
 ***56***
 ***57***
 ***58***
 ***59***
 ***60***
 ***61***
 ***62***
 ***63***
 ***64***
 ***65***
 ***66***
 ***67***
 ***68***
 ***69***
 ***70***
 ***71***
 ***72***
 ***73***
 ***74***
 ***75***
 ***76***
 ***77***
 ***78***
 ***79***
 ***80***
 ***81***
 ***82***
 ***83***
 ***84***
 ***85***
 ***86***
 ***87***
 ***88***
 ***89***
 ***90***
 ***91***
 ***92***
 ***93***
 ***94***
 ***95***
 ***96***
 ***97***
 ***0***

 */

#include <stdio.h>
#include <signal.h>
#include <setjmp.h>
#include <signal.h>
#include <errno.h>
#include <stdlib.h>
#include <stdio.h>
#include <time.h>
#include <math.h>
#include <sys/time.h>
#include <unistd.h>
#include <map>
#include <list>
#include "../uthreads.h"

int quantumR = 5000;
int currId = -1;
int maxRounds = 2;

/* Just prints its ID after process switch. */
void f()
{
    int id = uthread_get_tid();
    int rounds = -1;
    while (rounds < maxRounds){
        if(currId != id){
            currId = id;
            printf("***%d***\n", id);
            rounds++;
            fflush(stdout);

        }

    }
    uthread_terminate(id);


}


int main(int argc, char **argv)
{
    printf("test3:\n--------------\n");
    int i;
    int tid;
    int n = MAX_THREAD_NUM -2;

    uthread_init(quantumR);

    for (i=1; i<n; i++)
    {
        tid = uthread_spawn(f);

        if (tid == -1)
            fprintf(stderr, "unjustified failrure to spawn\n");
    }

    fflush(stdout);
    f();

    uthread_terminate(0);
    return 0;
}
